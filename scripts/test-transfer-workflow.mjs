#!/usr/bin/env node

/**
 * Script de test complet pour le workflow de transfert d'argent
 * Teste le workflow en 4 √©tapes : Caissier -> Auditeur -> Ex√©cuteur -> Caissier
 */

import 'dotenv/config'
import { neon } from '@neondatabase/serverless'
import { readFileSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

// Charger explicitement le fichier .env.local
try {
  const envPath = join(__dirname, '..', '.env.local')
  const envContent = readFileSync(envPath, 'utf8')
  envContent.split('\n').forEach(line => {
    const [key, value] = line.split('=')
    if (key && value) {
      process.env[key.trim()] = value.trim()
    }
  })
} catch (error) {
  console.log('‚ö†Ô∏è  Fichier .env.local non trouv√© ou erreur de lecture')
}

// Configuration de la base de donn√©es
const sql = neon(process.env.DATABASE_URL)

async function testTransferWorkflow() {
  console.log('üß™ Test complet du workflow de transfert d\'argent\n')

  try {
    // 1. R√©cup√©rer les utilisateurs de test
    console.log('1Ô∏è‚É£ R√©cup√©ration des utilisateurs de test...')
    
    const cashier = await sql`
      SELECT id::text, name, email, role FROM users 
      WHERE role = 'cashier' 
      ORDER BY created_at ASC 
      LIMIT 1
    `
    
    const auditor = await sql`
      SELECT id::text, name, email, role FROM users 
      WHERE role = 'auditor' 
      ORDER BY created_at ASC 
      LIMIT 1
    `
    
    const executor = await sql`
      SELECT id::text, name, email, role FROM users 
      WHERE role = 'executor' 
      ORDER BY created_at ASC 
      LIMIT 1
    `
    
    if (cashier.length === 0 || auditor.length === 0 || executor.length === 0) {
      throw new Error('Utilisateurs de test manquants. Assurez-vous que des utilisateurs cashier, auditor et executor existent.')
    }
    
    console.log(`   ‚úÖ Caissier: ${cashier[0].name} (${cashier[0].email})`)
    console.log(`   ‚úÖ Auditeur: ${auditor[0].name} (${auditor[0].email})`)
    console.log(`   ‚úÖ Ex√©cuteur: ${executor[0].name} (${executor[0].email})`)
    console.log('')

    // 2. √âtape 1 : Caissier √©met une transaction de transfert
    console.log('2Ô∏è‚É£ √âTAPE 1 - Caissier √©met une transaction de transfert...')
    
    const transferAmount = 100000 // 100,000 XAF
    const transferDescription = 'Test workflow - Transfert vers Europe'
    
    const transactionResult = await sql`
      INSERT INTO transactions (
        id, type, status, description, amount, currency, created_by, agency, details
      )
      VALUES (
        gen_random_uuid(), 'transfer', 'pending', ${transferDescription}, 
        ${transferAmount}, 'XAF', ${cashier[0].name}, 'Agence Centre', 
        '{"recipient": "John Doe", "destination": "France", "method": "Western Union"}'
      )
      RETURNING id::text, status, description, amount, created_by
    `
    
    const transaction = transactionResult[0]
    console.log(`   ‚úÖ Transaction cr√©√©e: ${transaction.id}`)
    console.log(`   ‚úÖ Statut initial: ${transaction.status}`)
    console.log(`   ‚úÖ Montant: ${transaction.amount} XAF`)
    console.log(`   ‚úÖ Cr√©√©e par: ${transaction.created_by}`)
    console.log('')

    // 3. √âtape 2 : Auditeur renseigne le montant r√©el et valide
    console.log('3Ô∏è‚É£ √âTAPE 2 - Auditeur renseigne le montant r√©el et valide...')
    
    const realAmountEUR = 140 // 140 EUR
    const eurToXAFRate = 656 // Taux de change
    
    // Calculer la commission
    const realAmountXAF = realAmountEUR * eurToXAFRate
    const commissionAmount = Math.max(0, transferAmount - realAmountXAF)
    
    console.log(`   üìä Montant re√ßu par caissier: ${transferAmount} XAF`)
    console.log(`   üìä Montant r√©el renseign√©: ${realAmountEUR} EUR (${realAmountXAF} XAF)`)
    console.log(`   üìä Commission calcul√©e: ${commissionAmount} XAF`)
    
    let newStatus
    let executorId = null
    
    if (commissionAmount >= 5000) {
      newStatus = 'validated'
      executorId = executor[0].id
      console.log(`   ‚úÖ Commission >= 5000 XAF ‚Üí Validation automatique`)
      console.log(`   ‚úÖ Ex√©cuteur assign√©: ${executor[0].name}`)
    } else {
      newStatus = 'rejected'
      console.log(`   ‚ùå Commission < 5000 XAF ‚Üí Rejet automatique`)
    }
    
    // Mettre √† jour la transaction
    const updatedResult = await sql`
      UPDATE transactions 
      SET 
        real_amount_eur = ${realAmountEUR},
        commission_amount = ${commissionAmount},
        status = ${newStatus},
        executor_id = ${executorId},
        updated_at = NOW()
      WHERE id = ${transaction.id}
      RETURNING id::text, status, commission_amount, executor_id, real_amount_eur
    `
    
    const updatedTransaction = updatedResult[0]
    console.log(`   ‚úÖ Statut final: ${updatedTransaction.status}`)
    console.log(`   ‚úÖ Commission: ${updatedTransaction.commission_amount} XAF`)
    console.log(`   ‚úÖ Montant r√©el: ${updatedTransaction.real_amount_eur} EUR`)
    console.log(`   ‚úÖ Ex√©cuteur: ${updatedTransaction.executor_id || 'Aucun'}`)
    console.log('')

    // 4. √âtape 3 : Ex√©cuteur ex√©cute la transaction
    if (updatedTransaction.status === 'validated') {
      console.log('4Ô∏è‚É£ √âTAPE 3 - Ex√©cuteur ex√©cute la transaction...')
      
      const receiptUrl = 'https://example.com/receipts/transfer-receipt.pdf'
      const executorComment = 'Transfert ex√©cut√© avec succ√®s via Western Union'
      
      const executedResult = await sql`
        UPDATE transactions 
        SET 
          status = 'executed',
          executed_at = NOW(),
          receipt_url = ${receiptUrl},
          executor_comment = ${executorComment},
          updated_at = NOW()
        WHERE id = ${transaction.id} AND executor_id = ${executor[0].id}
        RETURNING id::text, status, executed_at, receipt_url, executor_comment
      `
      
      const executedTransaction = executedResult[0]
      console.log(`   ‚úÖ Transaction ex√©cut√©e: ${executedTransaction.id}`)
      console.log(`   ‚úÖ Statut: ${executedTransaction.status}`)
      console.log(`   ‚úÖ Date d'ex√©cution: ${executedTransaction.executed_at}`)
      console.log(`   ‚úÖ Re√ßu: ${executedTransaction.receipt_url}`)
      console.log(`   ‚úÖ Commentaire: ${executedTransaction.executor_comment}`)
      console.log('')

      // 5. √âtape 4 : Caissier cl√¥ture la transaction
      console.log('5Ô∏è‚É£ √âTAPE 4 - Caissier cl√¥ture la transaction...')
      
      const completedResult = await sql`
        UPDATE transactions 
        SET 
          status = 'completed',
          updated_at = NOW()
        WHERE id = ${transaction.id}
        RETURNING id::text, status, updated_at
      `
      
      const completedTransaction = completedResult[0]
      console.log(`   ‚úÖ Transaction cl√¥tur√©e: ${completedTransaction.id}`)
      console.log(`   ‚úÖ Statut final: ${completedTransaction.status}`)
      console.log(`   ‚úÖ Date de cl√¥ture: ${completedTransaction.updated_at}`)
      console.log('')
    } else {
      console.log('4Ô∏è‚É£ √âTAPE 3 - Transaction rejet√©e, pas d\'ex√©cution n√©cessaire')
      console.log('')
    }

    // 6. V√©rification finale du workflow
    console.log('6Ô∏è‚É£ V√©rification finale du workflow...')
    
    const finalTransaction = await sql`
      SELECT 
        id::text, status, description, amount, currency, created_by, agency,
        real_amount_eur, commission_amount, executor_id, executed_at, 
        receipt_url, executor_comment, created_at::text as created_at, 
        updated_at::text as updated_at
      FROM transactions 
      WHERE id = ${transaction.id}
    `
    
    const final = finalTransaction[0]
    
    console.log('   üìã R√©sum√© de la transaction:')
    console.log(`      ID: ${final.id}`)
    console.log(`      Description: ${final.description}`)
    console.log(`      Montant: ${final.amount} ${final.currency}`)
    console.log(`      Statut final: ${final.status}`)
    console.log(`      Montant r√©el: ${final.real_amount_eur} EUR`)
    console.log(`      Commission: ${final.commission_amount} XAF`)
    console.log(`      Ex√©cuteur: ${final.executor_id || 'Aucun'}`)
    console.log(`      Date d'ex√©cution: ${final.executed_at || 'N/A'}`)
    console.log(`      Re√ßu: ${final.receipt_url || 'N/A'}`)
    console.log(`      Commentaire: ${final.executor_comment || 'N/A'}`)
    console.log('')

    // 7. Test des diff√©rents sc√©narios
    console.log('7Ô∏è‚É£ Test des diff√©rents sc√©narios de commission...')
    
    const scenarios = [
      {
        name: 'Commission √©lev√©e (Validation)',
        received: 150000,
        real: 200,
        expected: 'validated'
      },
      {
        name: 'Commission faible (Rejet)',
        received: 30000,
        real: 50,
        expected: 'rejected'
      },
      {
        name: 'Commission limite (Validation)',
        received: 5000 + (100 * eurToXAFRate),
        real: 100,
        expected: 'validated'
      }
    ]
    
    for (const scenario of scenarios) {
      console.log(`   üìã ${scenario.name}:`)
      
      const testTransaction = await sql`
        INSERT INTO transactions (
          id, type, status, description, amount, currency, created_by, agency, details
        )
        VALUES (
          gen_random_uuid(), 'transfer', 'pending', ${scenario.name}, 
          ${scenario.received}, 'XAF', 'Test User', 'Agence Centre', '{}'
        )
        RETURNING id::text
      `
      
      const testId = testTransaction[0].id
      const testRealAmountXAF = scenario.real * eurToXAFRate
      const testCommission = Math.max(0, scenario.received - testRealAmountXAF)
      const testStatus = testCommission >= 5000 ? 'validated' : 'rejected'
      
      await sql`
        UPDATE transactions 
        SET 
          real_amount_eur = ${scenario.real},
          commission_amount = ${testCommission},
          status = ${testStatus},
          executor_id = ${testStatus === 'validated' ? executor[0].id : null},
          updated_at = NOW()
        WHERE id = ${testId}
      `
      
      console.log(`      Montant re√ßu: ${scenario.received} XAF`)
      console.log(`      Montant r√©el: ${scenario.real} EUR`)
      console.log(`      Commission: ${testCommission} XAF`)
      console.log(`      Statut: ${testStatus}`)
      console.log(`      Attendu: ${scenario.expected}`)
      console.log(`      ${testStatus === scenario.expected ? '‚úÖ' : '‚ùå'} R√©sultat correct`)
      
      // Supprimer la transaction de test
      await sql`DELETE FROM transactions WHERE id = ${testId}`
      console.log('')
    }

    console.log('üéâ Test du workflow de transfert termin√© avec succ√®s !')
    console.log('\nüìù R√©sum√© du workflow test√©:')
    console.log('   ‚úÖ √âtape 1: Caissier √©met une transaction (statut: pending)')
    console.log('   ‚úÖ √âtape 2: Auditeur renseigne le montant r√©el')
    console.log('   ‚úÖ √âtape 2: Calcul automatique de la commission')
    console.log('   ‚úÖ √âtape 2: Validation/rejet automatique bas√© sur la commission')
    console.log('   ‚úÖ √âtape 2: Assignation automatique d\'un ex√©cuteur si valid√©')
    console.log('   ‚úÖ √âtape 3: Ex√©cuteur ex√©cute la transaction (statut: executed)')
    console.log('   ‚úÖ √âtape 4: Caissier cl√¥ture la transaction (statut: completed)')
    console.log('')
    console.log('üöÄ Le workflow de transfert d\'argent est fonctionnel !')

  } catch (error) {
    console.error('‚ùå Erreur lors du test du workflow:', error)
    throw error
  }
}

// Ex√©cuter le test
testTransferWorkflow()
  .then(() => {
    console.log('\nüéØ Prochaines √©tapes:')
    console.log('   1. Ajouter l\'interface pour l\'ex√©cuteur')
    console.log('   2. Impl√©menter le syst√®me de t√©l√©chargement de re√ßu')
    console.log('   3. Mettre √† jour les √©tats des transactions dans l\'UI')
    console.log('   4. Tester l\'int√©gration compl√®te')
  })
  .catch(error => {
    console.error('‚ùå √âchec du test:', error)
    process.exit(1)
  })
